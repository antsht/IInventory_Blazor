@using InventoryApp.Models
@using InventoryApp.Services
@inject EquipmentService EquipmentService
@inject WorkplaceService WorkplaceService
@inject EmployeeService EmployeeService

<div class="modal-overlay" @onclick="OnClose">
    <div class="modal-content" @onclick:stopPropagation="true">
        <div class="modal-header">
            <h2>@(Equipment == null ? "Добавить оборудование" : "Редактировать оборудование")</h2>
            <button class="btn-close" @onclick="OnClose">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <EditForm Model="formData" OnValidSubmit="HandleSubmit" class="modal-body">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label class="form-label">Название *</label>
                <InputText class="form-control" @bind-Value="formData.Name" placeholder="Например: Компьютер Dell Optiplex" />
                <ValidationMessage For="@(() => formData.Name)" />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Тип *</label>
                    <InputSelect class="form-control" @bind-Value="formData.Type">
                        @foreach (var type in EquipmentTypes.All)
                        {
                            <option value="@type.Key">@type.Value</option>
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label class="form-label">Статус *</label>
                    <InputSelect class="form-control" @bind-Value="formData.Status">
                        @foreach (var status in EquipmentStatuses.All)
                        {
                            <option value="@status.Key">@status.Value</option>
                        }
                    </InputSelect>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Производитель</label>
                    <InputText class="form-control" @bind-Value="formData.Manufacturer" placeholder="Dell, HP, Lenovo..." />
                </div>

                <div class="form-group">
                    <label class="form-label">Модель</label>
                    <InputText class="form-control" @bind-Value="formData.Model" placeholder="Optiplex 7010" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Инвентарный номер *</label>
                    <InputText class="form-control" @bind-Value="formData.InventoryNumber" placeholder="ИНВ-001234" />
                    <ValidationMessage For="@(() => formData.InventoryNumber)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Дата добавления</label>
                    <InputDate class="form-control" @bind-Value="formData.PurchaseDate" />
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Рабочее место</label>
                <div class="select-with-button">
                    <select class="form-control" value="@formData.WorkplaceId" @onchange="OnWorkplaceChanged">
                        <option value="">— Не указано —</option>
                        @foreach (var workplace in workplaces)
                        {
                            <option value="@workplace.Id">
                                @workplace.Name
                                @if (workplace.Employee != null)
                                {
                                    @($" ({workplace.Employee.FullName})")
                                }
                            </option>
                        }
                    </select>
                    <button type="button" class="btn btn-secondary btn-icon-only" @onclick="OpenWorkplaceEditor" title="Редактировать справочник рабочих мест">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                            <line x1="12" y1="11" x2="12" y2="17"></line>
                            <line x1="9" y1="14" x2="15" y2="14"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ответственный сотрудник</label>
                <div class="select-with-button">
                    <select class="form-control" @bind="formData.EmployeeId">
                        <option value="">— Не назначен —</option>
                        @foreach (var employee in employees)
                        {
                            <option value="@employee.Id">
                                @employee.FullName
                                @if (!string.IsNullOrEmpty(employee.Position))
                                {
                                    @($" ({employee.Position})")
                                }
                            </option>
                        }
                    </select>
                    <button type="button" class="btn btn-secondary btn-icon-only" @onclick="OpenEmployeeEditor" title="Редактировать справочник сотрудников">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                        </svg>
                    </button>
                </div>
                @if (formData.WorkplaceId.HasValue && formData.EmployeeId.HasValue)
                {
                    var workplace = workplaces.FirstOrDefault(w => w.Id == formData.WorkplaceId);
                    if (workplace?.EmployeeId != null && workplace.EmployeeId != formData.EmployeeId)
                    {
                        <div class="info-hint">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            Выбранный сотрудник отличается от ответственного за рабочее место
                        </div>
                    }
                }
            </div>

            <div class="form-group">
                <label class="form-label">Примечания</label>
                <InputTextArea class="form-control" @bind-Value="formData.Notes" rows="3" placeholder="Дополнительная информация..." />
            </div>

            <div class="modal-footer">
                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                    @(isSaving ? "Сохранение..." : "Сохранить")
                </button>
                <button type="button" class="btn btn-secondary" @onclick="OnClose">
                    Отмена
                </button>
            </div>
        </EditForm>
    </div>
</div>

@if (showWorkplaceEditor)
{
    <WorkplaceEditorModal OnClose="CloseWorkplaceEditor" SelectMode="false" />
}

@if (showEmployeeEditor)
{
    <EmployeeEditorModal OnClose="CloseEmployeeEditor" SelectMode="false" />
}

@code {
    [Parameter] public Equipment? Equipment { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    private EquipmentFormData formData = new();
    private bool isSaving = false;
    private List<Workplace> workplaces = new();
    private List<Employee> employees = new();
    private bool showWorkplaceEditor = false;
    private bool showEmployeeEditor = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadReferenceData();
    }

    protected override void OnParametersSet()
    {
        if (Equipment != null)
        {
            formData = new EquipmentFormData
            {
                Name = Equipment.Name,
                Type = Equipment.Type,
                Manufacturer = Equipment.Manufacturer,
                Model = Equipment.Model,
                InventoryNumber = Equipment.Barcode,
                PurchaseDate = Equipment.PurchaseDate?.ToDateTime(TimeOnly.MinValue),
                Status = Equipment.Status,
                WorkplaceId = Equipment.WorkplaceId,
                EmployeeId = Equipment.EmployeeId,
                Notes = Equipment.Notes
            };
        }
        else
        {
            formData = new EquipmentFormData();
        }
    }

    private async Task LoadReferenceData()
    {
        workplaces = await WorkplaceService.GetAllAsync();
        employees = await EmployeeService.GetAllAsync();
    }

    private void OnWorkplaceChanged(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value?.ToString(), out var workplaceId))
        {
            formData.WorkplaceId = workplaceId;
            
            // Auto-populate employee from workplace
            var workplace = workplaces.FirstOrDefault(w => w.Id == workplaceId);
            if (workplace?.EmployeeId != null)
            {
                formData.EmployeeId = workplace.EmployeeId;
            }
        }
        else
        {
            formData.WorkplaceId = null;
        }
    }

    private async Task HandleSubmit()
    {
        isSaving = true;

        try
        {
            var equipment = new Equipment
            {
                Id = Equipment?.Id ?? Guid.Empty,
                Barcode = formData.InventoryNumber,
                Name = formData.Name,
                Type = formData.Type,
                Manufacturer = formData.Manufacturer,
                Model = formData.Model,
                SerialNumber = "",
                PurchaseDate = formData.PurchaseDate.HasValue 
                    ? DateOnly.FromDateTime(formData.PurchaseDate.Value) 
                    : null,
                Status = formData.Status,
                WorkplaceId = formData.WorkplaceId,
                EmployeeId = formData.EmployeeId,
                Notes = formData.Notes
            };

            if (Equipment == null)
            {
                await EquipmentService.CreateAsync(equipment);
            }
            else
            {
                await EquipmentService.UpdateAsync(equipment);
            }

            await OnSaved.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving equipment: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void OpenWorkplaceEditor()
    {
        showWorkplaceEditor = true;
    }

    private async Task CloseWorkplaceEditor()
    {
        showWorkplaceEditor = false;
        await LoadReferenceData();
    }

    private void OpenEmployeeEditor()
    {
        showEmployeeEditor = true;
    }

    private async Task CloseEmployeeEditor()
    {
        showEmployeeEditor = false;
        await LoadReferenceData();
    }

    private class EquipmentFormData
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Название обязательно")]
        public string Name { get; set; } = "";
        public string Type { get; set; } = "PC";
        public string Manufacturer { get; set; } = "";
        public string Model { get; set; } = "";
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Инвентарный номер обязателен")]
        public string InventoryNumber { get; set; } = "";
        public DateTime? PurchaseDate { get; set; }
        public string Status { get; set; } = "active";
        public Guid? WorkplaceId { get; set; }
        public Guid? EmployeeId { get; set; }
        public string Notes { get; set; } = "";
    }
}

<style>
    .select-with-button {
        display: flex;
        gap: 0.5rem;
    }

    .select-with-button select {
        flex: 1;
    }

    .btn-icon-only {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.625rem;
        min-width: 2.5rem;
    }

    .btn-icon-only .icon {
        width: 1.125rem;
        height: 1.125rem;
    }

    .info-hint {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        margin-top: 0.375rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        color: var(--primary-700);
        background: var(--primary-50);
        border-radius: var(--radius-sm);
    }

    .icon-sm {
        width: 0.875rem;
        height: 0.875rem;
        flex-shrink: 0;
    }
</style>
