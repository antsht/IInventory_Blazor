@page "/audit"
@using InventoryApp.Models
@using InventoryApp.Services
@inject AuditService AuditService
@inject EquipmentService EquipmentService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Инвентаризация</PageTitle>

@if (currentAudit == null)
{
    <div class="card mb-6">
        <h2 class="card-title">Инвентаризация</h2>

        @if (!showNewAuditForm)
        {
            <button class="btn btn-primary" @onclick="() => showNewAuditForm = true">
                Начать новую инвентаризацию
            </button>
        }
        else
        {
            <div class="new-audit-form">
                <div class="form-group">
                    <label class="form-label">Имя проверяющего</label>
                    <input type="text" 
                           class="form-control" 
                           @bind="auditorName" 
                           placeholder="Иванов Иван Иванович" 
                           style="max-width: 400px;" />
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" @onclick="StartNewAudit">
                        Создать
                    </button>
                    <button class="btn btn-secondary" @onclick="() => showNewAuditForm = false">
                        Отмена
                    </button>
                </div>
            </div>
        }
    </div>

    <div class="card">
        <div class="card-header">
            <h3>История инвентаризаций</h3>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Проверяющий</th>
                        <th>Статус</th>
                        <th class="actions-col">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!audits.Any())
                    {
                        <tr>
                            <td colspan="4" class="empty-message">Инвентаризации не найдены</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var audit in audits)
                        {
                            <tr>
                                <td>@audit.AuditDate.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</td>
                                <td>@audit.Auditor</td>
                                <td>
                                    <span class="status-badge status-@audit.Status">
                                        @(audit.Status == "completed" ? "Завершено" : "В процессе")
                                    </span>
                                </td>
                                <td class="actions-col">
                                    <button class="btn btn-link" @onclick="() => OpenAudit(audit)">
                                        Открыть
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
}
else
{
    <div class="card mb-6">
        <div class="audit-header">
            <div>
                <h2 class="card-title">Инвентаризация</h2>
                <p class="audit-info">Проверяющий: @currentAudit.Auditor</p>
                <p class="audit-info-small">Начато: @currentAudit.AuditDate.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</p>
            </div>
            <button class="btn btn-link" @onclick="CloseAudit">
                Назад к списку
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card stat-total">
                <p class="stat-label">Всего оборудования</p>
                <p class="stat-value">@stats.Total</p>
            </div>
            <div class="stat-card stat-found">
                <p class="stat-label">Найдено</p>
                <p class="stat-value">@stats.Found</p>
            </div>
            <div class="stat-card stat-notfound">
                <p class="stat-label">Не найдено</p>
                <p class="stat-value">@stats.NotFound</p>
            </div>
        </div>

        @if (currentAudit.Status == "in_progress")
        {
            <div class="btn-group">
                <button class="btn btn-primary" @onclick="() => showScanner = true">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                        <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                        <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                        <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
                        <rect x="7" y="7" width="10" height="10"></rect>
                    </svg>
                    Сканировать штрихкод
                </button>
                <button class="btn btn-success" @onclick="CompleteAudit">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    Завершить инвентаризацию
                </button>
                <button class="btn btn-secondary" @onclick="DownloadReport">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Скачать отчет
                </button>
            </div>
        }
        else
        {
            <button class="btn btn-secondary" @onclick="DownloadReport">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Скачать отчет
            </button>
        }
    </div>

    <div class="audit-panels">
        <div class="card panel-found">
            <div class="panel-header panel-header-found">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    Найденное оборудование (@scannedItems.Count)
                </h3>
            </div>
            <div class="panel-content">
                @if (!scannedItems.Any())
                {
                    <p class="empty-message">Оборудование еще не отсканировано</p>
                }
                else
                {
                    <ul class="equipment-list">
                        @foreach (var item in scannedItems)
                        {
                            <li class="equipment-item">
                                <div class="item-main">
                                    <p class="item-name">@item.Equipment.Name</p>
                                    <p class="item-details">@GetTypeName(item.Equipment.Type) - @item.Equipment.Model</p>
                                    <p class="item-barcode">@item.Equipment.Barcode</p>
                                </div>
                                <span class="item-time">@item.ScannedAt.ToLocalTime().ToString("HH:mm:ss")</span>
                            </li>
                        }
                    </ul>
                }
            </div>
        </div>

        <div class="card panel-notfound">
            <div class="panel-header panel-header-notfound">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    Не найденное оборудование (@notFoundEquipment.Count)
                </h3>
            </div>
            <div class="panel-content">
                @if (!notFoundEquipment.Any())
                {
                    <p class="empty-message">Все оборудование найдено</p>
                }
                else
                {
                    <ul class="equipment-list">
                        @foreach (var eq in notFoundEquipment)
                        {
                            <li class="equipment-item">
                                <p class="item-name">@eq.Name</p>
                                <p class="item-details">@GetTypeName(eq.Type) - @eq.Model</p>
                                @if (!string.IsNullOrEmpty(eq.Location))
                                {
                                    <p class="item-location">Местоположение: @eq.Location</p>
                                }
                                <p class="item-barcode">@eq.Barcode</p>
                            </li>
                        }
                    </ul>
                }
            </div>
        </div>
    </div>
}

@if (showScanner)
{
    <BarcodeScannerModal OnScan="HandleScan" OnClose="() => showScanner = false" />
}

@code {
    private List<InventoryAudit> audits = new();
    private InventoryAudit? currentAudit = null;
    private List<AuditItem> scannedItems = new();
    private List<Equipment> notFoundEquipment = new();
    private (int Total, int Found, int NotFound) stats;
    private bool showNewAuditForm = false;
    private bool showScanner = false;
    private string auditorName = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadAudits();
    }

    private async Task LoadAudits()
    {
        audits = await AuditService.GetAllAsync();
    }

    private async Task StartNewAudit()
    {
        if (string.IsNullOrWhiteSpace(auditorName))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Введите имя проверяющего");
            return;
        }

        currentAudit = await AuditService.CreateAsync(auditorName);
        await LoadAuditData();
        showNewAuditForm = false;
        auditorName = "";
        await LoadAudits();
    }

    private async Task OpenAudit(InventoryAudit audit)
    {
        currentAudit = audit;
        await LoadAuditData();
    }

    private void CloseAudit()
    {
        currentAudit = null;
        scannedItems.Clear();
        notFoundEquipment.Clear();
    }

    private async Task LoadAuditData()
    {
        if (currentAudit == null) return;

        scannedItems = await AuditService.GetScannedItemsAsync(currentAudit.Id);
        notFoundEquipment = await AuditService.GetNotFoundEquipmentAsync(currentAudit.Id);
        stats = await AuditService.GetAuditStatsAsync(currentAudit.Id);
    }

    private async Task HandleScan(string barcode)
    {
        if (currentAudit == null) return;

        var result = await AuditService.ScanBarcodeAsync(currentAudit.Id, barcode);
        
        if (result.Success)
        {
            await LoadAuditData();
            showScanner = false;
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", result.Message);
        }
    }

    private async Task CompleteAudit()
    {
        if (currentAudit == null) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Завершить инвентаризацию?");
        if (confirmed)
        {
            await AuditService.CompleteAsync(currentAudit.Id);
            await JSRuntime.InvokeVoidAsync("alert", "Инвентаризация завершена");
            currentAudit = null;
            scannedItems.Clear();
            notFoundEquipment.Clear();
            await LoadAudits();
        }
    }

    private async Task DownloadReport()
    {
        if (currentAudit == null) return;

        var csv = await AuditService.GenerateCsvReportAsync(currentAudit.Id);
        var filename = $"audit_{currentAudit.Id}_{DateTime.Now:yyyy-MM-dd}.csv";
        
        await JSRuntime.InvokeVoidAsync("downloadFile", filename, csv);
    }

    private string GetTypeName(string type) => EquipmentTypes.All.GetValueOrDefault(type, type);
}


