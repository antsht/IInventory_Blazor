@inject IJSRuntime JSRuntime

<div class="modal-overlay" @onclick="OnClose">
    <div class="modal-content @(isCameraActive ? "" : "modal-sm")" @onclick:stopPropagation="true">
        <div class="modal-header">
            <h2>Сканирование инвентарного номера</h2>
            <button class="btn-close" @onclick="OnClose">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="modal-body">
            @if (isCameraActive)
            {
                <div class="camera-container @(showSuccess ? "scan-success-flash" : "") @(showError ? "scan-error-flash" : "")">
                    <div id="reader" style="width: 100%;"></div>
                    
                    @if (showSuccess)
                    {
                        <div class="scan-success-message">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            <span>@lastScannedCode</span>
                        </div>
                    }
                    else if (showError)
                    {
                        <div class="scan-error-message">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                            <span>@errorMessage</span>
                        </div>
                    }
                    else
                    {
                        <div class="scan-status">
                            <span class="scan-indicator"></span>
                            <span>Сканирование активно...</span>
                        </div>
                    }
                    
                    <p class="scan-hint">Расположите штрихкод внутри рамки</p>
                </div>

                @if (scannedCount > 0)
                {
                    <div class="scanned-counter">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 1.25rem; height: 1.25rem;">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        <span>Отсканировано: <strong>@scannedCount</strong></span>
                    </div>
                }

                <button class="btn btn-secondary mt-3 w-100" @onclick="StopCamera">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                    </svg>
                    Завершить сканирование
                </button>
            }
            else
            {
                <div class="scanner-info">
                    <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    <div>
                        <p class="info-title">Используйте сканер или камеру</p>
                        <p class="info-text">Отсканируйте штрихкод инвентарного номера или используйте камеру телефона</p>
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn btn-primary w-100 mb-3" @onclick="StartCamera">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                        Включить камеру
                    </button>

                    <label class="form-label">Инвентарный номер</label>
                    <input type="text" 
                           class="form-control barcode-input" 
                           @bind="barcodeInput" 
                           @bind:event="oninput"
                           @onkeydown="HandleKeyDown"
                           @ref="inputRef"
                           placeholder="Введите или отсканируйте номер"
                           autofocus />
                </div>
            }

            <div class="modal-footer">
                @if (!isCameraActive)
                {
                    <button class="btn btn-primary" @onclick="HandleScan" disabled="@string.IsNullOrWhiteSpace(barcodeInput)">
                        Ок
                    </button>
                }
                <button class="btn btn-secondary" @onclick="OnClose">
                    Закрыть
                </button>
            </div>

            <p class="hint-text">Нажмите ESC для закрытия</p>
        </div>
    </div>
</div>

@implements IAsyncDisposable

@code {
    [Parameter] public EventCallback<string> OnScan { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private string barcodeInput = "";
    private ElementReference inputRef;
    private DotNetObjectReference<BarcodeScannerModal>? dotNetRef;
    private bool isCameraActive = false;
    private bool showSuccess = false;
    private bool showError = false;
    private string lastScannedCode = "";
    private string errorMessage = "";
    private int scannedCount = 0;
    private HashSet<string> recentScans = new(); // Prevent duplicate scans
    private System.Timers.Timer? feedbackTimer;

    public void ShowSuccess(string code)
    {
        lastScannedCode = code;
        showSuccess = true;
        showError = false;
        scannedCount++;
        
        ResetFeedbackTimer();
        StateHasChanged();
    }

    public void ShowError(string message)
    {
        errorMessage = message;
        showError = true;
        showSuccess = false;
        
        ResetFeedbackTimer();
        StateHasChanged();
    }

    private void ResetFeedbackTimer()
    {
        feedbackTimer?.Stop();
        feedbackTimer?.Dispose();
        feedbackTimer = new System.Timers.Timer(2000);
        feedbackTimer.Elapsed += async (s, e) =>
        {
            feedbackTimer?.Stop();
            showSuccess = false;
            showError = false;
            await InvokeAsync(StateHasChanged);
        };
        feedbackTimer.Start();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (!isCameraActive)
            {
                try { await inputRef.FocusAsync(); } catch {}
            }
            dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("addEscListener", dotNetRef);
        }
    }

    private async Task StartCamera()
    {
        isCameraActive = true;
        scannedCount = 0;
        recentScans.Clear();
        StateHasChanged();
        await Task.Delay(150); // Give time for #reader to render
        try
        {
            await JSRuntime.InvokeVoidAsync("startScanner", dotNetRef, "reader");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting scanner: {ex.Message}");
            await Task.Delay(100);
            try { await JSRuntime.InvokeVoidAsync("startScanner", dotNetRef, "reader"); } catch {}
        }
    }

    private async Task StopCamera()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("stopScanner");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error stopping scanner: {ex.Message}");
        }
        isCameraActive = false;
        feedbackTimer?.Stop();
        feedbackTimer?.Dispose();
        StateHasChanged();
    }

    [JSInvokable]
    public async Task HandleScannerResult(string result)
    {
        if (!string.IsNullOrWhiteSpace(result))
        {
            // Prevent duplicate scans of the same barcode within short time
            if (recentScans.Contains(result))
            {
                return;
            }
            
            recentScans.Add(result);
            
            // Clear from recent after 3 seconds to allow re-scan
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                recentScans.Remove(result);
            });

            // Send the scanned code to parent (parent will call ShowSuccess or ShowError)
            await OnScan.InvokeAsync(result.Trim());
        }
    }

    [JSInvokable]
    public async Task HandleEscKey()
    {
        await OnClose.InvokeAsync();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(barcodeInput))
        {
            await HandleScan();
        }
        else if (e.Key == "Escape")
        {
            await OnClose.InvokeAsync();
        }
    }

    private async Task HandleScan()
    {
        if (!string.IsNullOrWhiteSpace(barcodeInput))
        {
            await OnScan.InvokeAsync(barcodeInput.Trim());
            barcodeInput = "";
        }
    }

    public async ValueTask DisposeAsync()
    {
        feedbackTimer?.Stop();
        feedbackTimer?.Dispose();
        if (isCameraActive)
        {
            try { await JSRuntime.InvokeVoidAsync("stopScanner"); } catch {}
        }
        dotNetRef?.Dispose();
    }
}
