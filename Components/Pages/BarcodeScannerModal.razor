@inject IJSRuntime JSRuntime

<div class="modal-overlay" @onclick="OnClose">
    <div class="modal-content modal-sm" @onclick:stopPropagation="true">
        <div class="modal-header">
            <h2>Сканирование инвентарного номера</h2>
            <button class="btn-close" @onclick="OnClose">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="modal-body">
            <div class="scanner-info">
                <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                    <circle cx="12" cy="13" r="4"></circle>
                </svg>
                <div>
                    <p class="info-title">Используйте сканер штрихкодов</p>
                    <p class="info-text">Отсканируйте штрихкод инвентарного номера или введите номер вручную в поле ниже</p>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Инвентарный номер</label>
                <input type="text" 
                       class="form-control barcode-input" 
                       @bind="barcodeInput" 
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown"
                       @ref="inputRef"
                       placeholder="Введите или отсканируйте инвентарный номер"
                       autofocus />
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" @onclick="HandleScan" disabled="@string.IsNullOrWhiteSpace(barcodeInput)">
                    Сканировать
                </button>
                <button class="btn btn-secondary" @onclick="OnClose">
                    Отмена
                </button>
            </div>

            <p class="hint-text">Нажмите ESC для закрытия</p>
        </div>
    </div>
</div>

@implements IDisposable

@code {
    [Parameter] public EventCallback<string> OnScan { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private string barcodeInput = "";
    private ElementReference inputRef;
    private DotNetObjectReference<BarcodeScannerModal>? dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await inputRef.FocusAsync();
            dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("addEscListener", dotNetRef);
        }
    }

    [JSInvokable]
    public async Task HandleEscKey()
    {
        await OnClose.InvokeAsync();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(barcodeInput))
        {
            await HandleScan();
        }
        else if (e.Key == "Escape")
        {
            await OnClose.InvokeAsync();
        }
    }

    private async Task HandleScan()
    {
        if (!string.IsNullOrWhiteSpace(barcodeInput))
        {
            await OnScan.InvokeAsync(barcodeInput.Trim());
            barcodeInput = "";
        }
    }

    public void Dispose()
    {
        dotNetRef?.Dispose();
    }
}


